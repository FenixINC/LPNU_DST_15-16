package cons;

import java.awt.event.ActionEvent;
import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.PrintWriter;
import java.net.Socket;
import java.net.UnknownHostException;

public class ConsoleInterp {
	
	static String[] partsout(String[] array, int index)
	{
		 String [] result = new String[array.length-index];
		 for (int i=index; i<(array.length); i++)
		  {
			 result[i-index] = array[i];
			 
	  	  }
		return result;
	}

public static byte[] serialize(Object obj) throws IOException {
    ByteArrayOutputStream out = new ByteArrayOutputStream();
    ObjectOutputStream os = new ObjectOutputStream(out);
    os.writeObject(obj);
    return out.toByteArray();
}
public static Object deserialize(byte[] data) throws IOException, ClassNotFoundException {
    ByteArrayInputStream in = new ByteArrayInputStream(data);
    ObjectInputStream is = new ObjectInputStream(in);
    return is.readObject();
}


	static void ping(Socket socket) throws IOException 
	{
		DataInputStream dis = new DataInputStream(socket.getInputStream());
		DataOutputStream dos = new DataOutputStream(socket.getOutputStream());
		dos.writeInt(1);
		dos.writeByte(1);
		byte[] nbm = new byte[dis.readInt()]; 
		dis.readFully(nbm);
		if(nbm.length == 1 && nbm[0] == 2) {
				System.out.println("Ping successfull");
			}
		else System.out.println("Ping unsuccessfull");
	}
	static void echo(Socket socket, String str) throws IOException 
	{
		DataInputStream dis = new DataInputStream(socket.getInputStream());
		DataOutputStream dos = new DataOutputStream(socket.getOutputStream());
		byte[] BytesOfString = str.getBytes();
		dos.writeInt(BytesOfString.length+1);
		dos.writeByte(3);
		dos.write(BytesOfString);
		byte[] nbm = new byte[dis.readInt()]; 
		dis.readFully(nbm);
				if(nbm.length > 1) {
		String str_received= new String(nbm, 0, nbm.length);
		System.out.println(str_received);
			}
		else System.out.println("Error "+nbm[0]);
	}
	static void login(Socket socket, String name, String password) throws IOException, ClassNotFoundException 
	{
		DataInputStream dis = new DataInputStream(socket.getInputStream());
		DataOutputStream dos = new DataOutputStream(socket.getOutputStream());
		byte[] bytes = serialize(new String[]{name, password});
		dos.writeInt(bytes.length+1);
		dos.writeByte(5);
		dos.write(bytes);
		byte[] nbm = new byte[dis.readInt()]; 
		if(nbm.length > 1) {
		Object obj = deserialize(nbm);
		System.out.println(obj);
			}
		else System.out.println("Error "+nbm[0]);
	}
	@SuppressWarnings("null")
	public static void main(String[] args) {
		try{
			   Socket socket = new Socket("0.0.0.0", 4321);
			   System.out.printf("Socket connection established%n");
			   PrintWriter out = new PrintWriter(socket.getOutputStream(), 
		                 true);
			   BufferedReader in = new BufferedReader(new InputStreamReader(
		                socket.getInputStream()));
			   String[] parts;
				InputStreamReader isr = new InputStreamReader ( System.in );
		BufferedReader br = new BufferedReader ( isr );
				String s = null;
				System.out.printf("Enter String%n");
		boolean isClosed=false;	
		   while ( !isClosed ) {
			   s = br.readLine ();
			   parts = s.split(" ");
			  
			  switch (parts[0]) {
	            case "ping": ping(socket);  
	            	        	break;
	            case "echo": echo(socket,String.join(" ", partsout(parts,1)));          	
	            	            break;
	            case "login": System.out.printf("Your command is 'login' with the parameters: name=%s, password=%s%n", parts[1], parts[2]);
	                     break;
	            case "list":  System.out.printf("Your command is 'list'%n");
	                     break;
	            case "msg":  System.out.printf("Your command is 'msg' with the name: %s, text of the msg is: %s%n",parts[1], String.join(" ", partsout(parts,2)));
	                     break;
	            case "file":  System.out.printf("Your command is 'file' with the parameters: username=%s, filename=%s%n", parts[1], parts[2]);
	                     break;
	            case "exit":  
	            isr.close();
	            br.close();
	            isClosed=true;
	            socket.close();
	            System.out.println("Program successfully terminated");
	                     break;
	            default: System.out.println("Invalid command");
	                     break;
	        }
		   }
		
		} 
		catch (UnknownHostException e) {
		     System.out.println("Unknown host: 0.0.0.0");
		     System.exit(1);
		   } catch  (IOException e) {
			   e.printStackTrace();
		   }
		
	}

}
